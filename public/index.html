<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00FF00">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - OM SRI RAM TRADERS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    background-color: #000;
    color: #00FF00;
  }

  .section {
    border: 2px solid #ccc;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
}

.extra-section {
    background: #181717;
}



.addRowBtn {
    margin-top: 10px;
    padding: 6px 12px;
    background: #00FF00;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}


  .navbar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: rgba(0,0,0,0.85);
    border-bottom: 2px solid #00FF00;
  }

  .navbar .logo {
    font-size: 1.8rem;
    font-weight: bold;
    color: #00FF00;
    flex: 1;
  }

  .navbar .datetime {
    color: #00FF00;
    flex: 1;
    text-align: left;
    font-weight: bold;
  }

  .navbar .nav-links {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .navbar .nav-links a {
    color: #00FF00;
    text-decoration: none;
    font-weight: 600;
    padding: 5px 12px;
    border-radius: 5px;
    transition: 0.2s;
    cursor: pointer;
  }

  .navbar .nav-links a:hover {
    background-color: #00FF00;
    color: #000;
  }

  .dashboard {
    display: flex;
    min-height: calc(100vh - 60px);
  }

  .sidebar {
    display: none; /* hide sidebar, top nav used for weekly points */
  }

  .main-content {
    flex-grow: 1;
    padding: 30px;
  }

  .main-content h2 {
    color: #00FF00;
    font-size: 1.8rem;
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    padding: 12px 15px;
    text-align: center;
    border: 2px solid #00FF00;
  }

  th {
    background-color: #00FF00;
    color: #000;
  }

  tr:nth-child(even) td {
    background-color: rgba(201, 218, 201, 0.1);
  }

  td input {
    width: 100px;
    padding: 6px;
    border-radius: 5px;
    border: 1px solid #00FF00;
    background: transparent;
    color: #00FF00;
    text-align: center;
  }

  td input:focus {
    outline: none;
    border-color: #00CC00;
    box-shadow: 0 0 8px #00FF00;
  }

  .btn {
    background-color: #00FF00;
    color: #000;
    font-weight: bold;
    padding: 5px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
    margin: 2px;
  }

  .btn:hover {
    background-color: #00CC00;
  }

  footer {
    text-align: center;
    padding: 12px;
    background-color: rgba(0,0,0,0.7);
    border-top: 2px solid #00FF00;
    color: #00FF00;
    font-size: 0.9rem;
  }

  .table-wrapper {
  width: 100%;
  overflow-x: auto; /* horizontal scroll if needed */
  -webkit-overflow-scrolling: touch; /* smooth scroll for mobile */
}

.table-wrapper table {
  min-width: 1200px; /* ensures table layout is preserved */
  width: 100%;
}

  .toast {
    min-width: 200px;
    margin-bottom: 10px;
    padding: 10px 15px;
    border-radius: 5px;
    color: #000;
    background-color: #00FF00;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.5s ease;
    font-weight: bold;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(0);
  }

  .toast.error {
    background-color: #FF3333;
    color: #fff;
  }

  .section-container { display: none; }
  .active { display: block; }

  /* Weekly Points Section */
  .weekly-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .controls label {
    display: inline-block;
    margin-right: 5px;
  }

  .controls input {
    margin-right: 10px;
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #00FF00;
    background: transparent;
    color: #00FF00;
  }

  .controls input:focus {
    outline: none;
    border-color: #00CC00;
    box-shadow: 0 0 5px #00FF00;
  }

  #sections { margin-top: 20px; }
  .section-card {
    border: 2px solid #00FF00;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 5px;
  }

  /* EXTRA SECTION HIGHLIGHT */
.extra-section .box {
  display: flex;
  gap: 30px;
  align-items: center;
  margin-bottom: 15px;
}

.extra-section label {
  font-weight: 600;
  font-size: 14px;
  display: block;
}

.extra-section input[id^="extra-"] {
  font-size: 22px;
  font-weight: bold;
  /* padding: 10px 14px; */
  width: 200px;
  border-radius: 8px;
  border: 2px solid #00FF00;
  background: #000;
  color: #00FF00;
  text-align: center;
  box-shadow: 0 0 12px rgba(0,255,0,0.4);
}

/* TOTAL AMOUNT MORE PROMINENT */
.extra-section input[id^="total-"] {
   font-size: 22px;
  font-weight: bold;
  /* padding: 10px 14px; */
  width: 200px;
  border-radius: 8px;
  border: 2px solid #00FF00;
  background: #000;
  color: #00FF00;
  text-align: center;
  box-shadow: 0 0 12px rgba(0,255,0,0.4);
}


</style>
</head>
<body>

<nav class="navbar">
  <div class="datetime" id="datetime"></div>
  <div class="logo">OM SRI RAM TRADERS</div>
  <div class="nav-links">
    <a onclick="showSection('points')">Points</a>
    <a onclick="showSection('weekly')">Weekly</a>
    <a onclick="showSection('salary')">Salary</a>
    <a onclick="showSection('extras')">Extras</a>
  </div>
</nav>

<div class="main-content">

  <!-- Points Section -->
  <div id="points" class="section-container active">
    <h2>Points Updation</h2>
    <table id="pointsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Points</th>
          <th>Per Point Cost</th>
          
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Salary Section -->
  <div id="salary" class="section-container">

    <h2>Salary Details</h2>
    <div class="table-wrapper">
    <table id="salaryTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Points</th>
          <th>Amount</th>
          <th>No. of Paavu</th>
          <th>Paavu Katta</th>
          <th>Maistery Amount</th>
          <th>Advance (Weekly)</th>
          <th>Advance (Monthly)</th>
          <th>Last Week Balance</th>
          <th>Total Amount</th>
          <th>RoundOff</th>
          <th>Paid Salary</th>
          <th>Bonus</th>
          <th>Final Amount</th>
          <th>Actions</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    </div>
    <button class="btn" onclick="addSalaryRow()">âž• Add Row</button>
  </div>

  <!-- Weekly Points Section -->
  <div id="weekly" class="section-container">
    <div class="weekly-header">
      <h2>Weekly Points</h2>
     
    </div>

    <div class="controls">
      <label>Names (comma separated)</label>
      <input id="namesInput" type="text" placeholder="e.g. Hari, Kumar, Ramesh">
      <label>From</label>
      <input id="fromDate" type="date">
      <label>To</label>
      <input id="toDate" type="date">
      <button class="btn" id="createSectionsBtn">Create Sections</button>
      <button class="btn" id="generateRowsBtn">Generate Rows</button>
    </div>
    <div id="sections"></div>
  </div>

  <!-- Extras Section -->
   <div id="extras" class="section-container">
  <h2>Extras</h2>
<div id="extraSections"></div>
  
  
</div>

  
</div>


<script>
  // Section toggle
  function showSection(id) {
    document.querySelectorAll('.section-container').forEach(sec => sec.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    if (id === 'extras') {
    refreshExtrasSection();
  }

  }


  function refreshExtrasSection() {
  document.querySelectorAll('.extra-section').forEach(section => {
    const name = section.dataset.name.replace('_extra', '');

    const paidSalary = getPaidSalary(name);

    const paidInput = section.querySelector(`#extra-${name}`);
    const totalInput = section.querySelector(`#total-${name}`);

    if (paidInput) paidInput.value = paidSalary;

    // Recalculate extras total
    let extraTotal = 0;
    section.querySelectorAll('.extra-amount').forEach(inp => {
      extraTotal += Number(inp.value) || 0;
    });

    if (totalInput) totalInput.value = paidSalary + extraTotal;
  });
}


  // Clock and date
  function updateDateTime() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('datetime').innerText = now.toLocaleString();
    const wc = document.getElementById('weekClock');
    if(wc) wc.innerText = now.toLocaleDateString(undefined, options) + ' ' + now.toLocaleTimeString();
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();


 



  const selectors = {
  sectionsContainer: '#sections',
  createSectionsBtn: '#createSectionsBtn',
  generateRowsBtn: '#generateRowsBtn',
  namesInput: '#namesInput',
  fromDate: '#fromDate',
  toDate: '#toDate'
};

// Dummy cost data for calculations
let costData = { points: 1.384, paavuKatta: 50 };

function renderPointsTable() {
    const tbody = document.querySelector("#pointsTable tbody");
    tbody.innerHTML = "";

    const rows = [
        { name: "Points", points: 1, cost: costData.points },
        { name: "Paavu Katta", points: 1, cost: costData.paavuKatta }
    ];

    rows.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row.name}</td>
            <td>${row.points}</td>
            <td>${row.cost}</td>
        `;
        tbody.appendChild(tr);
    });
}

renderPointsTable();


   

// ------------------- Salary Row -------------------
function createSalaryRowElement(data = {}) {
  const tr = document.createElement('tr');
  const nameVal = data.name || '';
  if (nameVal) tr.dataset.name = nameVal;

  tr.innerHTML = `
    <td><input type="text" value="${nameVal}" ${data.readonlyName?'readonly':''}></td>
    <td><input name="points" type="number" value="${data.points||0}" oninput="this.dispatchEvent(new Event('input'))"></td>
    <td><input name="amount" type="number" value="${data.amount||0}" disabled></td>
    <td><input name="noOfPaavu" type="number" value="${data.noOfPaavu||0}" oninput="this.dispatchEvent(new Event('input'))"></td>
    <td><input name="paavuKatta" type="number" value="${data.paavuKatta||0}" disabled></td>
    <td><input name="maisteryAmount" type="number" value="${data.maisteryAmount||0}"></td>
    <td><input name="advanceWeekly" type="number" value="${data.advanceWeekly||0}"></td>
    <td><input name="advanceMonthly" type="number" value="${data.advanceMonthly||0}"></td>
    <td>
      <div style="display:flex;align-items:center;gap:5px;">
        <button class="btn small" data-sign="-">-</button>
        <input name="lastWeek" type="number" value="${data.lastWeekBalance||0}">
        <button class="btn small" data-sign="+">+</button>
      </div>
    </td>
    <td><input name="totalAmount" type="number" value="${data.totalAmount||0}" disabled></td>
    <td><input name="roundOff" type="text" value="${data.roundOff||0}" readonly></td>
    <td><input name="paidSalary" type="number" value="${data.paidSalary||0}" disabled></td>
    <td><input name="bonus" type="number" value="${data.bonus||0}" disabled></td>
    <td><input name="finalAmount" type="number" value="${data.finalAmount||0}" disabled></td>
    <td><button class="btn saveBtn">Save</button> <button class="btn deleteBtn">Delete</button></td>
    <td><input type="text" class="dateField" value="${data.date||''}" readonly></td>
  `;
  return tr;
}

function addSalaryRow(data={}) {
  const tr = createSalaryRowElement(data);
  document.querySelector('#salaryTable tbody').appendChild(tr);
  tr.querySelectorAll('input').forEach(inp => {
  inp.addEventListener('input', () => calculateRowTotal(tr));
});
  calculateRowTotal(tr);
  // Add + and - button functionality
// Make value positive or negative based on button click
const minusBtn = tr.querySelector('button[data-sign="-"]');
const plusBtn = tr.querySelector('button[data-sign="+"]');
const lastWeekInput = tr.querySelector('input[name="lastWeek"]');

minusBtn.addEventListener('click', () => {
  let v = parseFloat(lastWeekInput.value) || 0;
  lastWeekInput.value = (-Math.abs(v)).toFixed(2);  // ALWAYS NEGATIVE
  calculateRowTotal(tr);
});

plusBtn.addEventListener('click', () => {
  let v = parseFloat(lastWeekInput.value) || 0;
  lastWeekInput.value = (Math.abs(v)).toFixed(2);  // ALWAYS POSITIVE
  calculateRowTotal(tr);
});


}

// ------------------- Salary Calculation -------------------
function calculateRowTotal(row) {
  if(!row) return;
  const get=(name)=>parseFloat(row.querySelector(`input[name="${name}"]`)?.value)||0;

  const points = get('points');
  const noOfPaavu = get('noOfPaavu');
  const maistery = get('maisteryAmount');
  const advWeekly = get('advanceWeekly');
  const advMonthly = get('advanceMonthly');
  const lastWeek = get('lastWeek');

  const amount = points*costData.points;
  const paavuKatta = noOfPaavu*costData.paavuKatta;

  row.querySelector('input[name="amount"]').value = amount.toFixed(2);
  row.querySelector('input[name="paavuKatta"]').value = paavuKatta.toFixed(2);

  const total = (amount+paavuKatta+maistery) - (advWeekly+advMonthly) + lastWeek;
  row.querySelector('input[name="totalAmount"]').value = total.toFixed(2);

  const remainder = total%10;
  let roundOff = 0;
  if(remainder!==0) roundOff = remainder<5?-remainder:10-remainder;
  const roundOffInput = row.querySelector('input[name="roundOff"]');
  roundOffInput.value = roundOff>0?`+${roundOff.toFixed(2)}`:roundOff.toFixed(2);

  const paid = total+roundOff;
  row.querySelector('input[name="paidSalary"]').value = paid.toFixed(2);

  const bonus = amount*0.0833;
  row.querySelector('input[name="bonus"]').value = bonus.toFixed(2);

  row.querySelector('input[name="finalAmount"]').value = (paid+bonus).toFixed(2);
}

// ------------------- Weekly Points Section -------------------
function createSectionElement(name){
  if(document.querySelector(`#sections .section[data-name="${CSS.escape(name)}"]`)) return null;
  const div = document.createElement('div');
  div.className='section';
  div.dataset.name=name;
  div.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong class="section-title">${name}</strong>
      <div><button class="btn danger delete-section">Delete Section</button></div>
    </div>
    <table>
      <thead><tr><th>Date</th><th>Day Shift</th><th>Night Shift</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  `;
  document.querySelector(selectors.sectionsContainer).appendChild(div);
  return div;
}

function appendRowToSection(sectionEl,rowData=null){
  const tbody = sectionEl.querySelector('tbody');
  const tr=document.createElement('tr');
  if(rowData?.id) tr.dataset.id=rowData.id;
  const dateValue=rowData?.date||'';
  const dayVal=rowData?.day_shift||0;
  const nightVal=rowData?.night_shift||0;
  tr.innerHTML=`
    <td><input name="date" type="date" value="${dateValue}" ${rowData?'disabled':''}></td>
    <td><input name="day_shift" type="number" value="${dayVal}"></td>
    <td><input name="night_shift" type="number" value="${nightVal}"></td>
    <td><button class="btn save-btn">Save</button> <button class="btn delete-btn">Delete</button></td>
  `;
  tbody.appendChild(tr);

  const saveBtn = tr.querySelector('.save-btn');
  saveBtn.addEventListener('click', ()=>{
    const inputs = tr.querySelectorAll('input');
    if(saveBtn.innerText==='Save'){
      inputs.forEach(i=>i.disabled=true);
      saveBtn.innerText='Edit';
    } else {
      inputs.forEach(i=>i.disabled=false);
      saveBtn.innerText='Save';
    }
    updateSectionPointsFromInput(tr.querySelector('input'));
  });

  tr.querySelector('.delete-btn').addEventListener('click', ()=>{
    tr.remove();
    updateAllSectionTotals();
  });

  tr.querySelectorAll('input[name="day_shift"], input[name="night_shift"]').forEach(i=>{
    i.addEventListener('input', ()=>updateSectionPointsFromInput(i));
  });
  return tr;
}

// ------------------- Sync Points to Salary -------------------
function updateSectionPointsFromInput(input){
  const section=input.closest('.section');
  if(!section) return;
  const name=section.dataset.name;
  let total=0;
  section.querySelectorAll('input[name="day_shift"], input[name="night_shift"]').forEach(i=>total+=Number(i.value)||0);
  const salaryRow = findSalaryRowByName(name);
  if(salaryRow){
    salaryRow.querySelector('input[name="points"]').value=total;
    calculateRowTotal(salaryRow);
    updateExtraPaidSalary(name);
  }
}

function updateExtraPaidSalary(name) {
  const paidSalary = getPaidSalary(name);
  const salaryField = document.getElementById("salary-" + name);
  salaryField.value = paidSalary;

}

function updateAllSectionTotals(){
  document.querySelectorAll('.section').forEach(section=>{
    const name=section.dataset.name;
    let total=0;
    section.querySelectorAll('input[name="day_shift"], input[name="night_shift"]').forEach(i=>total+=Number(i.value)||0);
    const salaryRow=findSalaryRowByName(name);
    if(salaryRow){
      salaryRow.querySelector('input[name="points"]').value=total;
      calculateRowTotal(salaryRow);
    }
  });
}

// ------------------- Helpers -------------------
function findSalaryRowByName(name){
  return Array.from(document.querySelectorAll('#salaryTable tbody tr')).find(r=>r.dataset.name===name);
}

function showToast(msg,isError=false){
  const t=document.createElement('div');
  t.className=`toast ${isError?'error':''}`;
  t.innerText=msg;
  document.getElementById('toastContainer').appendChild(t);
  setTimeout(()=>t.classList.add('show'),50);
  setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),500)},3000);
}

// ------------------- Section Buttons -------------------
document.querySelector(selectors.createSectionsBtn).addEventListener('click',()=>{
  const names=(document.querySelector(selectors.namesInput).value||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!names.length) return showToast('Enter at least one name',true);
  names.forEach(n=>{
    if(!document.querySelector(`#sections .section[data-name="${CSS.escape(n)}"]`)) createSectionElement(n);
    if(!findSalaryRowByName(n)) addSalaryRow({name:n,readonlyName:true}); 
    if(!document.querySelector(`#extraSections .extra-section[data-name="${CSS.escape(n)}"]`))
        createExtraSectionElement(n);
  });
});

document.querySelector(selectors.generateRowsBtn).addEventListener('click',()=>{
  const from=document.querySelector(selectors.fromDate).value;
  const to=document.querySelector(selectors.toDate).value;
  if(!from||!to) return showToast('Select From and To dates',true);
  const start=new Date(from), end=new Date(to);
  if(end<start) return showToast('To must be >= From',true);

  const dates=[];
  for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)) dates.push(new Date(d).toISOString().split('T')[0]);
  const sections=document.querySelectorAll('#sections .section');
  const prettyFrom = formatPrettyDate(from);
const prettyTo = formatPrettyDate(to);
const finalRange = `${prettyFrom} â†’ ${prettyTo}`;

document.querySelectorAll('#salaryTable tbody tr').forEach(row => {
  const dateField = row.querySelector('.dateField');
  if (dateField) dateField.value = finalRange;
});
  sections.forEach(sec=>{
    const tbody=sec.querySelector('tbody');
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{if(!tr.dataset.id) tr.remove();});
    dates.forEach(dateIso=>{
      const exists=Array.from(tbody.querySelectorAll('input[name="date"]')).some(i=>i.value===dateIso);
      if(!exists) appendRowToSection(sec,{date:dateIso});
    });
  });
  showToast(`Rows created for ${dates.length} day(s)`);
});

// Delegate section-level buttons
document.querySelector('#sections').addEventListener('click', e => {
  const btn = e.target;
  if(btn.classList.contains('delete-section')){
    const section = btn.closest('.section');
    if(!section) return;
    const name = section.dataset.name;
    if(!confirm(`Delete entire section "${name}"?`)) return;
    section.remove(); // remove from DOM
    // optional: remove corresponding salary row
    const salaryRow = findSalaryRowByName(name);
    if(salaryRow) salaryRow.remove();
    showToast(`Section "${name}" deleted`);
  }
});

function formatPrettyDate(dateStr) {
  const d = new Date(dateStr);
  const day = d.getDate();
  const month = d.toLocaleString('en-US', { month: 'short' });
  const year = d.getFullYear();

  // Ordinal suffix
  const suffix = (day % 10 === 1 && day !== 11) ? "st" :
                 (day % 10 === 2 && day !== 12) ? "nd" :
                 (day % 10 === 3 && day !== 13) ? "rd" : "th";

  return `${day}${suffix} ${month} ${year}`;
}


// calculateRowTotal(salaryRow);



// ------------------- Extras Section -------------------

// Create an extra section for a given name
function createExtraSectionElement(name) {
    const container = document.getElementById("extraSections");

    // ðŸ”¥ Always recalc salary row before fetching
    const paidSalary = getPaidSalary(name);
    console.log("paid", paidSalary)

    const div = document.createElement("div");
    div.className = "section extra-section";
    div.dataset.name = name + "_extra";

    div.innerHTML = `
        <h3>${name} - Extra</h3>
        <div class="box">
            <label>Paid Salary:</label>
            <input id="extra-${name}" name="paidSalary" type="number" value="${paidSalary}" disabled>

            <label>Total Amount:</label>
            <input id="total-${name}" type="number" value="${paidSalary}" disabled>
        </div>

        <table class="extraTable" id="extraTable-${name}">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button class="addRowBtn" onclick="addExtraRow('${name}')">âž• Add Extra</button>

        <button class="btn" onclick="generateReport('${name}', 'excel')">ðŸ“Š Export Excel</button>
        <button class="btn" onclick="generateReport('${name}', 'pdf')">ðŸ“„ Export PDF</button>

    `;

    container.appendChild(div);
}

// Add a new extra row
function addExtraRow(sectionName) {
    const tbody = document.querySelector(`#extraTable-${sectionName} tbody`);
    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td><input type="text" class="extra-name"></td>
        <td><input type="number" class="extra-amount" oninput="updateExtraTotal('${sectionName}')"></td>
    `;

    tbody.appendChild(tr);
}

// Update total when extras change
function updateExtraTotal(sectionName) {
    const paidSalary = getPaidSalary(sectionName); // ðŸ”¥ always recalc
    const totalField = document.getElementById(`total-${sectionName}`);

    let totalExtras = 0;
    document.querySelectorAll(`#extraTable-${sectionName} .extra-amount`).forEach(input => {
        totalExtras += Number(input.value) || 0;
    });

    totalField.value = paidSalary + totalExtras;
}

// Helper: get latest Paid Salary from salary table
function getPaidSalary(name) {
    const row = findSalaryRowByName(name);
    console.log("rpw",row)
    if (!row) return 0;

    calculateRowTotal(row); // ðŸ”¥ ensure latest calculation
    const paidCell = row.querySelector('input[name="paidSalary"]');
    console.log(paidCell?.value)
    return paidCell ? parseFloat(paidCell.value) || 0 : 0;
}

function generateReport(name, type) {
  const data = [];

  /* -------- POINTS -------- */
  document.querySelectorAll("#pointsTable tbody tr").forEach(tr => {
    data.push({
      Section: "Points",
      Field: tr.children[0].innerText,
      Value: tr.children[2].innerText
    });
  });

  /* -------- WEEKLY -------- */
  const section = document.querySelector(`#sections .section[data-name="${CSS.escape(name)}"]`);
  if (section) {
    section.querySelectorAll("tbody tr").forEach(tr => {
      data.push({
        Section: "Weekly",
        Field: tr.querySelector('input[name="date"]').value,
        Value: `Day: ${tr.querySelector('input[name="day_shift"]').value}, Night: ${tr.querySelector('input[name="night_shift"]').value}`
      });
    });
  }

  /* -------- SALARY -------- */
  const salaryRow = findSalaryRowByName(name);
  if (salaryRow) {
    salaryRow.querySelectorAll("input").forEach(inp => {
      if (inp.name) {
        data.push({
          Section: "Salary",
          Field: inp.name,
          Value: inp.value
        });
      }
    });
  }

  /* -------- EXTRAS -------- */
  document.querySelectorAll(`#extraTable-${name} tbody tr`).forEach(tr => {
    data.push({
      Section: "Extras",
      Field: tr.querySelector('.extra-name').value,
      Value: tr.querySelector('.extra-amount').value
    });
  });

  if (type === "excel") exportExcel(name, data);
  if (type === "pdf") exportPDF(name, data);
}

function exportExcel(name, data = []) {
  const wb = XLSX.utils.book_new();
  const suffix = getFileSuffix();

  /* -------- WEEKLY -------- */
  const weeklyData = [];
  const section = document.querySelector(`#sections .section[data-name="${CSS.escape(name)}"]`);

  section?.querySelectorAll("tbody tr").forEach(tr => {
    weeklyData.push({
      Date: tr.querySelector('[name="date"]').value,
      DayShift: tr.querySelector('[name="day_shift"]').value,
      NightShift: tr.querySelector('[name="night_shift"]').value
    });
  });

  XLSX.utils.book_append_sheet(
    wb,
    XLSX.utils.json_to_sheet(weeklyData),
    "Weekly"
  );

  /* -------- SALARY -------- */
  const salaryRow = findSalaryRowByName(name);
  const salaryData = [];

  salaryRow?.querySelectorAll("input").forEach(inp => {
    if (inp.name) salaryData.push({ Field: inp.name, Value: inp.value });
  });

  XLSX.utils.book_append_sheet(
    wb,
    XLSX.utils.json_to_sheet(salaryData),
    "Salary"
  );

  /* -------- EXTRAS -------- */
  const extrasData = [];
  document.querySelectorAll(`#extraTable-${name} tbody tr`).forEach(tr => {
    extrasData.push({
      ExtraName: tr.querySelector(".extra-name").value,
      Amount: tr.querySelector(".extra-amount").value
    });
  });

  XLSX.utils.book_append_sheet(
    wb,
    XLSX.utils.json_to_sheet(extrasData),
    "Extras"
  );

  /* -------- FINAL SUMMARY -------- */
  const summary = getFinalSummary(name);

  XLSX.utils.book_append_sheet(
    wb,
    XLSX.utils.json_to_sheet([
      { Label: "Paid Salary", Amount: summary.paidSalary },
      { Label: "Total Amount", Amount: summary.totalAmount }
    ]),
    "Final Summary"
  );

  XLSX.writeFile(wb, `${name}_${suffix}.xlsx`);
}


function exportPDF(name) {
  const doc = new window.jspdf.jsPDF();
  const { from, to } = getDateRangeRaw();
  const suffix = getFileSuffix();

  const pageWidth = doc.internal.pageSize.getWidth();

doc.setFontSize(18);
doc.setFont(undefined, "bold");
doc.text(
  "OM SRI RAM TRADERS",
  pageWidth / 2,
  15,
  { align: "center" }
);
  doc.setFontSize(14);
  doc.text(`${name} - Salary Report`, 14, 25);

// const pageWidth = doc.internal.pageSize.getWidth();

doc.autoTable({
  startY: 30,
  head: [["DATE RANGE", ":",from + " to "+ to]],
  theme: "grid",
  styles: {
    halign: "center",
    fontStyle: "bold",
    fontSize: 11
  },
   headStyles: {
   
    textColor: [0, 0, 0]
  }

});

let y = doc.lastAutoTable.finalY + 8;

  


  

  // let y = 40;

  /* ---------- WEEKLY ---------- */
  const weeklyBody = [];
  const section = document.querySelector(`#sections .section[data-name="${CSS.escape(name)}"]`);

  if (section) {
    section.querySelectorAll("tbody tr").forEach(tr => {
      weeklyBody.push([
        tr.querySelector('[name="date"]').value,
        tr.querySelector('[name="day_shift"]').value,
        tr.querySelector('[name="night_shift"]').value
      ]);
    });
  }

  doc.autoTable({
    startY: y,
    head: [["Date", "Day Shift", "Night Shift"]],
    body: weeklyBody,
    theme: "grid"
  });

  y = doc.lastAutoTable.finalY + 8;

  /* ---------- SALARY ---------- */
  const salaryBody = [];
  const salaryRow = findSalaryRowByName(name);

  salaryRow?.querySelectorAll("input").forEach(inp => {
    if (inp.name) salaryBody.push([inp.name, inp.value]);
  });

  doc.autoTable({
    startY: y,
    head: [["Salary Field", "Value"]],
    body: salaryBody,
    theme: "grid"
  });

  y = doc.lastAutoTable.finalY + 8;

  /* ---------- EXTRAS ---------- */
  const extrasBody = [];
  document.querySelectorAll(`#extraTable-${name} tbody tr`).forEach(tr => {
    extrasBody.push([
      tr.querySelector(".extra-name").value,
      tr.querySelector(".extra-amount").value
    ]);
  });

  doc.autoTable({
    startY: y,
    head: [["Extra Name", "Amount"]],
    body: extrasBody,
    theme: "grid"
  });

  y = doc.lastAutoTable.finalY + 10;

  /* ---------- FINAL SUMMARY ---------- */
  const summary = getFinalSummary(name);

  doc.autoTable({
    startY: y,
    head: [["Final Summary", "Amount"]],
    body: [
      ["Paid Salary", summary.paidSalary],
      ["Total Amount", summary.totalAmount]
    ],
    theme: "grid",
    styles: { fontStyle: "bold" }
  });

  doc.save(`${name}_${suffix}.pdf`);
}



function getDateRangeText() {
  const from = document.getElementById("fromDate")?.value;
  const to = document.getElementById("toDate")?.value;

  if (!from || !to) return "Date Range: Not Selected";

  return `Date Range: ${formatPrettyDate(from)} 'to' ${formatPrettyDate(to)}`;
}


function getDateRangeRaw() {
  const from = document.getElementById("fromDate")?.value || "NA";
  const to = document.getElementById("toDate")?.value || "NA";
  return { from, to };
}

function getFileSuffix() {
  const { from, to } = getDateRangeRaw();
  return `${from}_to_${to}`;
}


function getFinalSummary(name) {
  const paidSalary = getPaidSalary(name);
  let extraTotal = 0;

  document.querySelectorAll(`#extraTable-${name} .extra-amount`)
    .forEach(i => extraTotal += Number(i.value) || 0);

  return {
    paidSalary: paidSalary.toFixed(2),
    totalAmount: (paidSalary + extraTotal).toFixed(2)
  };
}



  

</script>



<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"></script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
